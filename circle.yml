general:
  branches:
    ignore:

machine:
  environment:
    docker_image: marcelhuberfoo/pandoc-gitit
    docker_file: Dockerfile
    docker_context: .
    ver_file: pandoc_gitit_version.sh
  services:
    - docker
  timeout: 1200

dependencies:
  override:
    - docker info
    - docker build --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                   --build-arg VCS_REF=$(git rev-parse --short HEAD)
                   --build-arg PANDOC_VERSION=$(./$ver_file f | cut -d"_" -f1)
                   --build-arg GITIT_VERSION=$(./$ver_file f | cut -d"_" -f2)
                   --tag=$docker_image --file=$docker_file $docker_context:
                           timeout:1200

test:
  override:
    - docker run -it --rm --entrypoint /bin/sh $docker_image -c 'echo ${PANDOC_VERSION}_${GITIT_VERSION}'
    - docker run -it --rm --entrypoint /bin/sh $docker_image -c 'printenv'

deployment:
  release:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push $docker_image
      - docker tag $docker_image $docker_image:$(docker run -it --rm --entrypoint /bin/sh $docker_image -c 'echo -n ${PANDOC_VERSION}_${GITIT_VERSION}')
      - docker push $docker_image:$(docker run -it --rm --entrypoint /bin/sh $docker_image -c 'echo -n ${PANDOC_VERSION}_${GITIT_VERSION}')

